// HTF Reversal OPTIMIZED - Hammer + RSI + Trend Strategy
// Based on backtest analysis: Hammer + RSI Oversold + EMA Trend
// @version=6

strategy("HTF Reversal OPTIMIZED", overlay=true, default_qty_type=strategy.fixed, default_qty_value=1)

// === INPUTS ===
rsiLength = input.int(14, "RSI Length")
atrMultiplier = input.float(1.5, "ATR Multiplier for SL")
rrRatio = input.float(1.5, "Risk:Reward Ratio")  // Optimized: 1.5 instead of 2.0

// Trend Inputs
emaFast = input.int(20, "EMA Fast Period")
emaSlow = input.int(50, "EMA Slow Period")

// RSI Oversold Level
rsiOversoldLevel = input.int(35, "RSI Oversold Level")

// === RSI ===
rsiVal = ta.rsi(close, rsiLength)
rsiOversold = rsiVal < rsiOversoldLevel

// === EMA TREND ===
ema20 = ta.ema(close, emaFast)
ema50 = ta.ema(close, emaSlow)
trendUp = ema20 > ema50
trendDown = ema20 < ema50

// === HAMMER PATTERN (Bullish Reversal) ===
body = math.abs(close - open)
candleRange = high - low
lowerWick = math.min(close, open) - low
upperWick = high - math.max(close, open)

isHammer = body < candleRange * 0.33 and lowerWick > body * 2 and upperWick < body

// === SHOOTING STAR (Bearish Reversal) ===
isShootingStar = body < candleRange * 0.33 and upperWick > body * 2 and lowerWick < body

// === COMBINED SIGNALS ===
// OPTIMIZED: Hammer + RSI Oversold + Trend
longSignal = isHammer and rsiOversold and trendUp
shortSignal = isShootingStar and (rsiVal > (100 - rsiOversoldLevel)) and trendDown

// === ATR FOR STOP LOSS ===
atrValue = ta.atr(14)
stopDistance = atrValue * atrMultiplier

// === PLOTS ===
plotshape(longSignal, title="LONG", location=location.belowbar, color=color.lime, 
     style=shape.triangleup, size=size.normal, text="HAMMER\nLONG")
plotshape(shortSignal, title="SHORT", location=location.abovebar, color=color.red, 
     style=shape.triangledown, size=size.normal, text="SHOOTING\nSTAR")

// Plot EMA
plot(ema20, color=color.blue, title="EMA 20")
plot(ema50, color=color.orange, title="EMA 50")

// Background color for trend
bgcolor(trendUp ? color.new(color.green, 90) : trendDown ? color.new(color.red, 90) : na)

// === ENTRIES ===
if (longSignal)
    stopLoss = close - stopDistance
    takeProfit = close + (stopDistance * rrRatio)
    strategy.entry("Long", strategy.long, stop=stopLoss, limit=takeProfit)

if (shortSignal)
    stopLoss = close + stopDistance
    takeProfit = close - (stopDistance * rrRatio)
    strategy.entry("Short", strategy.short, stop=stopLoss, limit=takeProfit)

// === PLOT SL AND TP ===
plot(strategy.position_size > 0 ? close - stopDistance : na, color=color.red, title="Long SL")
plot(strategy.position_size > 0 ? close + (stopDistance * rrRatio) : na, color=color.green, title="Long TP")
plot(strategy.position_size < 0 ? close + stopDistance : na, color=color.red, title="Short SL")
plot(strategy.position_size < 0 ? close - (stopDistance * rrRatio) : na, color=color.green, title="Short TP")

// === INFO TABLE ===
var table infoTable = table.new(position.top_right, 5, 3, bgcolor=color.new(color.gray, 90), frame_width=1, frame_color=color.gray)

if barstate.islast
    table.cell(infoTable, 0, 0, "Signal", text_color=color.white, text_size=size.small)
    table.cell(infoTable, 1, 0, "RSI", text_color=color.white, text_size=size.small)
    table.cell(infoTable, 2, 0, "Trend", text_color=color.white, text_size=size.small)
    table.cell(infoTable, 3, 0, "SL", text_color=color.white, text_size=size.small)
    table.cell(infoTable, 4, 0, "TP", text_color=color.white, text_size=size.small)
    
    signalText = longSignal ? "LONG" : shortSignal ? "SHORT" : "None"
    signalColor = longSignal ? color.lime : shortSignal ? color.red : color.gray
    
    table.cell(infoTable, 0, 1, signalText, text_color=signalColor, text_size=size.small)
    table.cell(infoTable, 1, 1, str.tostring(rsiVal, "#.0"), text_color=color.white, text_size=size.small)
    table.cell(infoTable, 2, 1, trendUp ? "UP" : "DN", text_color=trendUp ? color.green : color.red, text_size=size.small)
    table.cell(infoTable, 3, 1, str.tostring(stopDistance, "#.00"), text_color=color.red, text_size=size.small)
    table.cell(infoTable, 4, 1, str.tostring(stopDistance * rrRatio, "#.00"), text_color=color.green, text_size=size.small)

// === ALERTS ===
alertcondition(longSignal, title="Long Signal", message="Hammer + RSI Oversold + Uptrend LONG")
alertcondition(shortSignal, title="Short Signal", message="Shooting Star + RSI Overbought + Downtrend SHORT")
